<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Smart Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .nav-tabs .nav-link.active { background-color: #e9ecef; border-color: #dee2e6 #dee2e6 #fff; font-weight: bold; }
        /* Admin butonunu baÅŸta gizle */
        .admin-only { display: none !important; } 
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary px-4">
    <span class="navbar-brand mb-0 h1">Smart Library System</span>
    <button onclick="logout()" class="btn btn-light btn-sm">Logout</button>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2 id="welcomeText">Welcome</h2>
        <button id="addBookBtn" class="btn btn-dark admin-only" data-bs-toggle="modal" data-bs-target="#addBookModal">
            + Add New Book
        </button>
    </div>
    <hr>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="catalog-tab" data-bs-toggle="tab" data-bs-target="#catalog" type="button">ðŸ“š Library Catalog</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button" onclick="loadMyLoans()">ðŸ“– My Active Loans</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fines-tab" data-bs-toggle="tab" data-bs-target="#fines" type="button" onclick="loadMyFines()">ðŸ’° My Fines</button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="myTabContent">
        
        <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search books by title, author or ISBN..." onkeyup="filterBooks()">
        
        <div class="tab-pane fade show active" id="catalog">
            <h4>Available Books</h4>
            <table class="table table-hover">
                <thead class="table-dark"><tr><th>Title</th><th>Author</th><th>ISBN</th><th>Action</th></tr></thead>
                <tbody id="booksTableBody"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="loans">
            <h4>Books You Have Borrowed</h4>
            <table class="table table-hover">
                <thead class="table-secondary"><tr><th>Book</th><th>Borrow Date</th><th>Due Date</th><th>Action</th></tr></thead>
                <tbody id="loansTableBody"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="fines">
            <h4>Unpaid Fines</h4>
            <table class="table table-hover">
                <thead class="table-danger"><tr><th>Amount</th><th>Reason</th><th>Date</th><th>Action</th></tr></thead>
                <tbody id="finesTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pay Fine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Total Amount: <strong id="payAmount">0.0 TL</strong></p>
                <input type="hidden" id="payFineId">
                <div class="mb-2"><input type="text" class="form-control" placeholder="Card Number" value="5528790000000001"></div>
                <div class="row">
                    <div class="col"><input type="text" class="form-control" placeholder="MM" value="12"></div>
                    <div class="col"><input type="text" class="form-control" placeholder="YYYY" value="2030"></div>
                    <div class="col"><input type="text" class="form-control" placeholder="CVC" value="123"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="processPayment()">Pay Now</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBookForm">
                    <div class="mb-2"><input type="text" id="newTitle" class="form-control" placeholder="Book Title" required></div>
                    <div class="mb-2"><input type="text" id="newAuthor" class="form-control" placeholder="Author" required></div>
                    <div class="mb-2"><input type="text" id="newIsbn" class="form-control" placeholder="ISBN (13 digits)" required></div>
                    <div class="mb-2"><input type="number" id="newYear" class="form-control" placeholder="Publication Year" value="2024"></div>
                    <div class="mb-2"><input type="text" id="newCategory" class="form-control" placeholder="Category" value="General"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="saveNewBook()">Save Book</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- GÃœVENLÄ°K VE GÄ°RÄ°Åž KONTROLÃœ ---
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login';

    const user = JSON.parse(localStorage.getItem('user'));
    document.getElementById('welcomeText').textContent = `Welcome, ${user ? user.username : 'User'}`;

    // --- ADMIN KONTROLÃœ ---
    if (user && user.role === 'admin') {
        document.getElementById('addBookBtn').classList.remove('admin-only'); // Admin ise butonu gÃ¶ster
        document.getElementById('addBookBtn').style.display = 'block';
    }

    // --- 1. KÄ°TAPLARI LÄ°STELE ---
    async function loadBooks() {
        try {
            const res = await fetch('/api/books', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.status === 401) { logout(); return; }
            
            const books = await res.json();
            const tbody = document.getElementById('booksTableBody');
            tbody.innerHTML = books.map(b => `
                <tr>
                    <td>${b.title}</td><td>${b.author}</td><td>${b.isbn}</td>
                    <td><button class="btn btn-success btn-sm" onclick="borrowBook(${b.id})">Borrow</button></td>
                </tr>
            `).join('');
        } catch (e) { console.error(e); }
    }

    // --- ADMIN: KÄ°TAP EKLEME FONKSÄ°YONU ---
    async function saveNewBook() {
        const title = document.getElementById('newTitle').value;
        const author = document.getElementById('newAuthor').value;
        const isbn = document.getElementById('newIsbn').value;
        const year = document.getElementById('newYear').value;
        const category = document.getElementById('newCategory').value;

        if(!title || !author || !isbn) {
            Swal.fire('Warning', 'Please fill in all required fields!', 'warning');
            return;
        }

        try {
            const res = await fetch('/api/books/', {  // Dikkat: Sondaki / Ã¶nemli olabilir
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ 
                    title: title, author: author, isbn: isbn, 
                    publication_year: parseInt(year), category: category 
                })
            });

            const data = await res.json();

            if(res.ok) {
                Swal.fire('Saved!', 'New book added successfully.', 'success');
                // ModalÄ± kapat
                const modal = bootstrap.Modal.getInstance(document.getElementById('addBookModal'));
                modal.hide();
                // Formu temizle
                document.getElementById('addBookForm').reset();
                // Listeyi yenile
                loadBooks();
            } else {
                Swal.fire('Error', data.error || 'Failed to add book.', 'error');
            }
        } catch (e) {
            Swal.fire('Error', 'Connection failed.', 'error');
        }
    }

    // --- KÄ°TAP Ã–DÃœNÃ‡ AL (SWEETALERT Ä°LE) ---
    async function borrowBook(id) {
        // GÃ¼zel bir onay kutusu
        const result = await Swal.fire({
            title: 'Borrow this book?',
            text: "You will have 15 days to return it.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, borrow it!'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch('/api/loans/borrow', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ book_id: id })
            });
            const data = await res.json();
            
            if(res.ok) {
                Swal.fire('Borrowed!', 'The book is yours. Check your email.', 'success');
                loadBooks(); 
            } else {
                Swal.fire('Oops...', data.error || data.message, 'error');
            }
        } catch (e) { Swal.fire('Error', 'Connection error', 'error'); }
    }

    // --- 2. AKTÄ°F Ã–DÃœNÃ‡LERÄ° LÄ°STELE ---
    async function loadMyLoans() {
        const res = await fetch('/api/loans/my-loans', { headers: { 'Authorization': 'Bearer ' + token } });
        const loans = await res.json();
        const tbody = document.getElementById('loansTableBody');
        
        if(loans.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No active loans.</td></tr>'; 
            return; 
        }
        
        tbody.innerHTML = loans.map(l => `
            <tr>
                <td>${l.book}</td>
                <td>${new Date(l.borrow_date).toLocaleDateString()}</td>
                <td class="text-danger fw-bold">${new Date(l.due_date).toLocaleDateString()}</td>
                <td><button class="btn btn-warning btn-sm" onclick="returnBook(${l.id}, ${l.book_id})">Return</button></td>
            </tr>
        `).join(''); 
    }

    // --- KÄ°TAP Ä°ADE ET ---
    async function returnBook(loanId, bookId) {
        const result = await Swal.fire({
            title: 'Return this book?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, return it!'
        });

        if (!result.isConfirmed) return;
        
        try {
            const res = await fetch('/api/loans/return', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ book_id: bookId }) 
            });
            
            const data = await res.json();
            
            if (data.fine_applied) {
                Swal.fire('Penalty Applied!', data.message, 'warning');
            } else {
                if(res.ok) Swal.fire('Returned!', 'Book returned successfully.', 'success');
                else Swal.fire('Error', data.message || 'Error', 'error');
            }
            
            loadMyLoans(); 
        } catch(e) { Swal.fire('Error', 'Processing failed.', 'error'); }
    }

    // --- 3. CEZALARI LÄ°STELE ---
    async function loadMyFines() {
        const res = await fetch('/api/payments/my-fines', { headers: { 'Authorization': 'Bearer ' + token } });
        const fines = await res.json();
        const tbody = document.getElementById('finesTableBody');
        
        if(fines.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No unpaid fines. Great!</td></tr>'; 
            return; 
        }

        tbody.innerHTML = fines.map(f => `
            <tr>
                <td>${f.amount} TL</td>
                <td>${f.reason}</td>
                <td>${new Date(f.created_at).toLocaleDateString()}</td>
                <td><button class="btn btn-primary btn-sm" onclick="openPaymentModal(${f.id}, ${f.amount})">Pay</button></td>
            </tr>
        `).join('');
    }

    // --- Ã–DEME Ä°ÅžLEMLERÄ° ---
    let currentFineId = null;
    function openPaymentModal(id, amount) {
        currentFineId = id;
        document.getElementById('payAmount').innerText = amount + ' TL';
        new bootstrap.Modal(document.getElementById('paymentModal')).show();
    }

    async function processPayment() {
        try {
            const res = await fetch('/api/payments/pay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({
                    fine_id: currentFineId,
                    card_number: "5528790000000001",
                    expire_month: "12",
                    expire_year: "2030",
                    cvc: "123"
                })
            });
            const data = await res.json();
            
            if(res.ok) {
                Swal.fire('Paid!', 'Payment Successful!', 'success').then(() => location.reload());
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        } catch(e) { Swal.fire('Error', 'Payment failed.', 'error'); }
    }

    // --- ARAMA FONKSÄ°YONU ---
    function filterBooks() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.getElementById('booksTableBody').getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const text = rows[i].textContent.toLowerCase();
            rows[i].style.display = text.includes(input) ? '' : 'none';
        }
    }

    function logout() { 
        localStorage.removeItem('token'); 
        localStorage.removeItem('user'); 
        window.location.href = '/login'; 
    }

    // BaÅŸlangÄ±Ã§ta kitaplarÄ± yÃ¼kle
    loadBooks();
</script>

</body>
</html>