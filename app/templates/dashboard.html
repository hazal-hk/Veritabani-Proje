<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Smart Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .nav-tabs .nav-link.active { background-color: #e9ecef; border-color: #dee2e6 #dee2e6 #fff; font-weight: bold; }
        .admin-only { display: none !important; } 
    </style>
</head>
<body>

<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 1055;">
    <div style="background:white; margin:10% auto; padding:20px; width:300px; border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3>Edit Book</h3>
        <input type="hidden" id="editBookId">
        
        <label class="form-label">Book Title:</label>
        <input type="text" id="editTitle" class="form-control mb-2">
        
        <label class="form-label">Author:</label>
        <input type="text" id="editAuthor" class="form-control mb-2">
        
        <label class="form-label">ISBN:</label>
        <input type="text" id="editIsbn" class="form-control mb-3">
        
        <div class="d-flex justify-content-end gap-2">
            <button onclick="closeModal()" class="btn btn-secondary btn-sm">Cancel</button>
            <button onclick="submitUpdate()" class="btn btn-success btn-sm">Save Changes</button>
        </div>
    </div>
</div>

<nav class="navbar navbar-dark bg-primary px-4">
    <span class="navbar-brand mb-0 h1">Smart Library System</span>
    <button onclick="logout()" class="btn btn-light btn-sm">Logout</button>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2 id="welcomeText">Welcome</h2>
        <button id="addBookBtn" class="btn btn-dark admin-only" data-bs-toggle="modal" data-bs-target="#addBookModal">
            + Add New Book
        </button>
    </div>
    <hr>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="catalog-tab" data-bs-toggle="tab" data-bs-target="#catalog" type="button">ðŸ“š Library Catalog</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button" onclick="loadMyLoans()">ðŸ“– My Active Loans</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fines-tab" data-bs-toggle="tab" data-bs-target="#fines" type="button" onclick="loadMyFines()">ðŸ’° My Fines</button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="myTabContent">
        
        <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search books by title, author or ISBN..." onkeyup="filterBooks()">
        
        <div class="tab-pane fade show active" id="catalog">
            <h4>Available Books</h4>
            <table class="table table-hover">
                <thead class="table-dark"><tr><th>Title</th><th>Author</th><th>ISBN</th><th>Status</th><th>Action</th></tr></thead>
                <tbody id="booksTableBody"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="loans">
            <h4>Books You Have Borrowed</h4>
            <table class="table table-hover">
                <thead class="table-secondary"><tr><th>Book</th><th>Borrow Date</th><th>Due Date</th><th>Action</th></tr></thead>
                <tbody id="loansTableBody"></tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="fines">
            <h4>Unpaid Fines</h4>
            <table class="table table-hover">
                <thead class="table-danger"><tr><th>Amount</th><th>Reason</th><th>Date</th><th>Action</th></tr></thead>
                <tbody id="finesTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pay Fine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Total Amount: <strong id="payAmount">0.0 TL</strong></p>
                <input type="hidden" id="payFineId">
                <div class="mb-2"><input type="text" class="form-control" placeholder="Card Number" value="5528790000000001"></div>
                <div class="row">
                    <div class="col"><input type="text" class="form-control" placeholder="MM" value="12"></div>
                    <div class="col"><input type="text" class="form-control" placeholder="YYYY" value="2030"></div>
                    <div class="col"><input type="text" class="form-control" placeholder="CVC" value="123"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="processPayment()">Pay Now</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBookForm">
                    <div class="mb-2"><input type="text" id="newTitle" class="form-control" placeholder="Book Title" required></div>
                    <div class="mb-2"><input type="text" id="newAuthor" class="form-control" placeholder="Author" required></div>
                    <div class="mb-2"><input type="text" id="newIsbn" class="form-control" placeholder="ISBN (13 digits)" required></div>
                    <div class="mb-2"><input type="number" id="newYear" class="form-control" placeholder="Publication Year" value="2024"></div>
                    <div class="mb-2"><input type="text" id="newCategory" class="form-control" placeholder="Category" value="General"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="saveNewBook()">Save Book</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- SECURITY & AUTH CHECK ---
    const token = localStorage.getItem('access_token') || localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/login';
    }

    const user = JSON.parse(localStorage.getItem('user'));
    document.getElementById('welcomeText').textContent = `Welcome, ${user ? user.username : 'User'}`;

    // --- ADMIN CHECK ---
    if (user && user.role === 'admin') {
        document.getElementById('addBookBtn').classList.remove('admin-only'); 
        document.getElementById('addBookBtn').style.display = 'block';
    }

    // --- 1. LOAD BOOKS (ROLE BASED) ---
    async function loadBooks() {
        try {
            const response = await fetch('/api/books', { 
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const books = await response.json();
            const tableBody = document.getElementById('booksTableBody');
            tableBody.innerHTML = '';

            books.forEach(book => {
                let actionButtons = '';

                // IF ADMIN: Show Edit & Delete
                if (user && user.role === 'admin') {
                    actionButtons = `
                        <button onclick="openEditModal(${book.id}, '${book.title}', '${book.author}', '${book.isbn}')" 
                                class="btn btn-warning btn-sm">Edit</button>
                        <button onclick="deleteBook(${book.id})" 
                                class="btn btn-danger btn-sm ms-1">Delete</button>
                    `;
                } 
                // IF STUDENT: Show Borrow
                else {
                    actionButtons = `
                        <button onclick="borrowBook(${book.id})" 
                                class="btn btn-info btn-sm text-white">Borrow</button>
                    `;
                }

                const row = `
                    <tr>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.isbn}</td>
                        <td><span class="badge bg-${book.status === 'LOANED' ? 'warning' : 'success'}">${book.status || 'Available'}</span></td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        } catch (error) {
            console.error("Error loading books:", error);
        }
    }

    // --- ADMIN: ADD BOOK ---
    async function saveNewBook() {
        const title = document.getElementById('newTitle').value;
        const author = document.getElementById('newAuthor').value;
        const isbn = document.getElementById('newIsbn').value;
        const year = document.getElementById('newYear').value;
        const category = document.getElementById('newCategory').value;

        if(!title || !author || !isbn) {
            Swal.fire('Warning', 'Please fill in all required fields!', 'warning');
            return;
        }

        try {
            const res = await fetch('/api/books', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ 
                    title: title, author: author, isbn: isbn, 
                    publication_year: parseInt(year), category: category 
                })
            });

            const data = await res.json();

            if(res.ok) {
                Swal.fire('Saved!', 'New book added successfully.', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('addBookModal'));
                modal.hide();
                document.getElementById('addBookForm').reset();
                loadBooks();
            } else {
                Swal.fire('Error', data.error || 'Failed to add book.', 'error');
            }
        } catch (e) {
            Swal.fire('Error', 'Connection failed.', 'error');
        }
    }

        // --- ADMIN: DELETE BOOK (SMART CHECK) ---
    async function deleteBook(id) {
        // 1. Ä°lk uyarÄ±: Standart silme sorusu
        const firstConfirm = await Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        });

        if (!firstConfirm.isConfirmed) return;
        
        try {
            // 2. Normal silme isteÄŸi gÃ¶nder
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            let response = await fetch(`/api/books/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            // 3. EÄŸer Backend "409" dÃ¶nerse (KayÄ±tlar var demek)
            if (response.status === 409) {
                // Ä°kinci uyarÄ±yÄ± gÃ¶ster: "KayÄ±tlar var, yine de sileyim mi?"
                const forceConfirm = await Swal.fire({
                    title: 'Dependency Warning!',
                    text: "This book has past loan records attached. Deleting it will wipe those records too. Proceed anyway?",
                    icon: 'error', // KÄ±rmÄ±zÄ± uyarÄ±
                    showCancelButton: true,
                    confirmButtonColor: '#d33', // KÄ±rmÄ±zÄ± buton
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, FORCE DELETE!'
                });

                if (forceConfirm.isConfirmed) {
                    // 4. Force Delete isteÄŸi gÃ¶nder (?force=true)
                    response = await fetch(`/api/books/${id}?force=true`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } else {
                    return; // KullanÄ±cÄ± ikinci soruda vazgeÃ§ti
                }
            }

            // 5. SonuÃ§ kontrolÃ¼
            if (response.ok) {
                Swal.fire('Deleted!', 'The book (and its history) has been deleted.', 'success');
                loadBooks(); // Listeyi yenile
            } else {
                const err = await response.json();
                Swal.fire('Error', err.error || "Could not delete.", 'error');
            }

        } catch (e) {
            console.error(e);
            Swal.fire('Error', 'Connection error!', 'error');
        }
    }

    // --- ADMIN: UPDATE BOOK ---
    function openEditModal(id, title, author, isbn) {
        document.getElementById('editBookId').value = id;
        document.getElementById('editTitle').value = title;
        document.getElementById('editAuthor').value = author;
        document.getElementById('editIsbn').value = isbn;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function submitUpdate() {
        const id = document.getElementById('editBookId').value;
        const updatedData = {
            title: document.getElementById('editTitle').value,
            author: document.getElementById('editAuthor').value,
            isbn: document.getElementById('editIsbn').value
        };

        try {
            const response = await fetch(`/api/books/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updatedData)
            });

            if (response.ok) {
                Swal.fire('Success', 'Book updated successfully!', 'success');
                closeModal();
                loadBooks();
            } else {
                Swal.fire('Error', 'Update failed!', 'error');
            }
        } catch (e) {
            Swal.fire('Error', 'Server error!', 'error');
        }
    }

    // --- STUDENT: BORROW BOOK ---
    async function borrowBook(id) {
        const result = await Swal.fire({
            title: 'Borrow this book?',
            text: "You will have 15 days to return it.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, borrow it!'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch('/api/loans/borrow', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ book_id: id })
            });
            const data = await res.json();
            
            if(res.ok) {
                Swal.fire('Borrowed!', 'The book is yours.', 'success');
                loadBooks(); 
            } else {
                Swal.fire('Oops...', data.error || data.message, 'error');
            }
        } catch (e) { Swal.fire('Error', 'Connection error', 'error'); }
    }

    // --- STUDENT: ACTIVE LOANS ---
    async function loadMyLoans() {
        const res = await fetch('/api/loans/my-loans', { headers: { 'Authorization': 'Bearer ' + token } });
        const loans = await res.json();
        const tbody = document.getElementById('loansTableBody');
        
        if(loans.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No active loans.</td></tr>'; 
            return; 
        }
        
        tbody.innerHTML = loans.map(l => `
            <tr>
                <td>${l.book}</td>
                <td>${new Date(l.borrow_date).toLocaleDateString()}</td>
                <td class="text-danger fw-bold">${new Date(l.due_date).toLocaleDateString()}</td>
                <td><button class="btn btn-warning btn-sm" onclick="returnBook(${l.id}, ${l.book_id})">Return</button></td>
            </tr>
        `).join(''); 
    }

    // --- STUDENT: RETURN BOOK ---
    async function returnBook(loanId, bookId) {
        const result = await Swal.fire({
            title: 'Return this book?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, return it!'
        });

        if (!result.isConfirmed) return;
        
        try {
            const res = await fetch('/api/loans/return', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ book_id: bookId }) 
            });
            
            const data = await res.json();
            
            if (data.fine_applied) {
                Swal.fire('Penalty Applied!', data.message, 'warning');
            } else {
                if(res.ok) Swal.fire('Returned!', 'Book returned successfully.', 'success');
                else Swal.fire('Error', data.message || 'Error', 'error');
            }
            
            loadMyLoans(); 
            loadBooks(); // Update catalog status
        } catch(e) { Swal.fire('Error', 'Processing failed.', 'error'); }
    }

    // --- STUDENT: FINES ---
    async function loadMyFines() {
        const res = await fetch('/api/payments/my-fines', { headers: { 'Authorization': 'Bearer ' + token } });
        const fines = await res.json();
        const tbody = document.getElementById('finesTableBody');
        
        if(fines.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No unpaid fines. Great!</td></tr>'; 
            return; 
        }

        tbody.innerHTML = fines.map(f => `
            <tr>
                <td>${f.amount} TL</td>
                <td>${f.reason}</td>
                <td>${new Date(f.created_at).toLocaleDateString()}</td>
                <td><button class="btn btn-primary btn-sm" onclick="openPaymentModal(${f.id}, ${f.amount})">Pay</button></td>
            </tr>
        `).join('');
    }

    // --- PAYMENT ---
    let currentFineId = null;
    function openPaymentModal(id, amount) {
        currentFineId = id;
        document.getElementById('payAmount').innerText = amount + ' TL';
        new bootstrap.Modal(document.getElementById('paymentModal')).show();
    }

    async function processPayment() {
        try {
            const res = await fetch('/api/payments/pay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({
                    fine_id: currentFineId,
                    card_number: "5528790000000001",
                    expire_month: "12",
                    expire_year: "2030",
                    cvc: "123"
                })
            });
            const data = await res.json();
            
            if(res.ok) {
                Swal.fire('Paid!', 'Payment Successful!', 'success').then(() => {
                    loadMyFines(); 
                    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                    modal.hide();
                });
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        } catch(e) { Swal.fire('Error', 'Payment failed.', 'error'); }
    }

    // --- SEARCH ---
    function filterBooks() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.getElementById('booksTableBody').getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const text = rows[i].textContent.toLowerCase();
            rows[i].style.display = text.includes(input) ? '' : 'none';
        }
    }

    function logout() { 
        localStorage.removeItem('access_token'); 
        localStorage.removeItem('token'); 
        localStorage.removeItem('user'); 
        window.location.href = '/login'; 
    }

    // Init
    window.onload = loadBooks;
</script>

</body>
</html>